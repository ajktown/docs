pipeline {
  agent any
  environment {
    GIT_REPO_URL="https://github.com/ajktown/wordnote.git"
    CLONED_REPO_DIR_NAME="cloned_repo_dir"
    BUILDING_IMAGE_NAME="ajktown/wordnote:latest"
    DOCKER_HUB_PUSHER_ACCESS_TOKEN = credentials("LOCAL_AJ_MAC_JENKINS_ACCESS_TOKEN") // Corrected credential syntax
    JWT_CREDENTIAL_ID = '141ad962-6926-46af-9c32-4fe9ec500dbe'  // Replace with your actual Credential ID
    JWKS_URL = 'http://localhost:8080/manage/descriptorByName/io.jenkins.plugins.oidc_provider.IdTokenStringCredentials/jwks?id=141ad962-6926-46af-9c32-4fe9ec500dbe&issuer=https://localhost:18080/oidc'
  }
  stages {
    stage('Clean Up') {
      steps {
        echo 'Cleaning up ...'
        deleteDir()
      }
    }

    stage('Retrieve and Print JWT') {
      steps {
        script {
          withCredentials([string(credentialsId: env.JWT_CREDENTIAL_ID, variable: 'JWT')]) {
            echo "JWT Retrieved Successfully!"
            sh 'echo $JWT > /tmp/jwt_debug.jwt'
          }
          sh 'cat /tmp/jwt_debug.jwt'  // This will print the JWT without masking!
        }
      }
    }

    stage('Check if environment [LOCAL_AJ_MAC_JENKINS_ACCESS_TOKEN] is available') {
      steps {
        script {
          if (env.DOCKER_HUB_PUSHER_ACCESS_TOKEN == null || env.DOCKER_HUB_PUSHER_ACCESS_TOKEN == "") {
            error("Failed to proceed: Required environment variable [DOCKER_HUB_PUSHER_ACCESS_TOKEN] is missing. Please add it to the Jenkins Credential Store.")
          }
        }
      }
    }
    stage("Clone GitHub Repo") {
      steps {
        echo "Cloning the GitHub repository ..."
        sh "git clone ${env.GIT_REPO_URL} ${env.CLONED_REPO_DIR_NAME}"
        sh "ls -al ${env.CLONED_REPO_DIR_NAME}"
      }
    }
    stage('Inspect (Test) cloned repository before building') {
      steps {
        echo 'Inspecting ...'
        dir("${env.CLONED_REPO_DIR_NAME}") { // Fixed variable usage
          sh "yarn"
          sh "yarn test"
          sh "yarn inspect"
        }
      }
    }
    // stage("Build with Docker") {
    //   steps {
    //     echo "Building the Docker image ..."
    //     dir("${env.CLONED_REPO_DIR_NAME}") { // Fixed variable usage
    //       sh "docker build -t ${env.BUILDING_IMAGE_NAME} ."
    //     }
    //   }
    // }
    // stage('Push to DockerHub Registry') {
    //   steps {
    //     echo 'Pushing image ...'
    //     dir("${env.CLONED_REPO_DIR_NAME}") { // Fixed variable usage
    //       sh "echo '${env.DOCKER_HUB_PUSHER_ACCESS_TOKEN}' | docker login -u ajktown --password-stdin" // More secure
    //       sh "docker push ${env.BUILDING_IMAGE_NAME}"
    //     }
    //   }
    // }
    // stage('Restart EC2 Instance') {
    //   steps {
    //     echo 'Restarting EC2 instance (This will indirectly restart the pods running on the EC2 instance) ...'
    //     echo 'TODO: Not implemented yet'
    //   }
    // } // Fixed missing closing bracket
  }
}